# SERVICE ##########################################

# Запуск проекта
make deploy

# создать виртуальное окружение
apt install python3.10-venv
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt

# удалить всех пользователей
curl -X DELETE https://vpnzi-dev.ru/api/users/delete_all/

# Выполнить миграции
docker compose exec vpn_zi_sing_box_server python manage.py makemigrations

# LINUX ##########################################

# подключение к серверу
ssh -i C:\Users\PC\.ssh\id_ed25519 root@85.198.91.116

# DOCKER ##########################################

#Запуск с пересборкой 
docker-compose up -d --build

# SING BOX ##########################################

# Сгенерировать пару ключей
sing-box generate reality-keypair

# Генерация UUID
sing-box generate uuid

# посмотреть конфигурацию
nano /etc/sing-box/config.json
cat /etc/sing-box/config.json

# проверить конфигурацию
sing-box check -c /etc/sing-box/config.json

# перезапустить 
systemctl restart sing-box

# применить конфигурацию
systemctl reload sing-box

# статус
systemctl status sing-box -l

# логи
journalctl -u sing-box -n 20

# Создание сервера #####################################################

#Версия Ubuntu 22.04 x64
#Выбрать установку Docker

#Обновляем пакеты:
sudo apt update && sudo apt upgrade -y
#Configuration file '/etc/cloud/cloud.cfg' тут можно нажать y

#Проверяем свободный порт 443:
sudo ss -lntp | grep 443
#Если кто-то слушает, нужно остановить сервис или выбрать другой порт.

#Установка singbox через скрипт
curl -fsSL https://sing-box.app/install.sh | sh
#Проверка установки
sing-box version
#Включить автозапуск при старте сервака
sudo systemctl enable sing-box

# Установка vpn_zi_sing_box_server

#Создать каталог для проектов 
mkdir /home/projects

#Клонирование репозитория
#Создать ssh-ключи
ssh-keygen -t ed25519 -C "zinindenis1983@ya.ru"
#Показать содержимое публичного ключа
cat ~/.ssh/id_ed25519.pub
#Скопировать и добавить ключ в github Заходишь на GitHub → Settings → SSH and GPG keys → New SSH key
#Проверить подключение ssh -T git@github.com
cd /home/projects
git clone git@github.com:BobbeYo1983/vpn_zi_sing_box_server.git
#Обязательные настройки для пуша
git config --global user.email "zinindenis1983@ya.ru"
git config --global user.name "Zinin Denis"

Генерация ключей
sing-box generate reality-keypair

Генерация short_id
sing-box generate rand --hex 8

# Настройка автоматического применения конфигурации при перезаписи

# Создаём сервис 
nano /etc/systemd/system/sing-box-reload.service

# Зписываем в файл
[Unit]
Description=Reload sing-box when config changes

[Service]
Type=oneshot
ExecStart=/bin/systemctl reload sing-box

 # Создаём path unit (наблюдатель за файлом)
nano /etc/systemd/system/sing-box.path

# Записываем в файл
[Unit]
Description=Watch sing-box config.json for changes

[Path]
PathModified=/etc/sing-box/config.json
PathChanged=/etc/sing-box/config.json
Unit=sing-box-reload.service

[Install]
WantedBy=multi-user.target

# Перечитать конфигурацию systemd
systemctl daemon-reexec
systemctl daemon-reload

# Включаем и запускаем watcher
systemctl enable sing-box.path
systemctl start sing-box.path

# Проверка
systemctl status sing-box.path

# Права для Django appuser (UID 1000)
sudo chown -R 1000:1000 /etc/sing-box
sudo chmod -R 755 /etc/sing-bo

# Смотреть логи
journalctl -u sing-box-reload.service -n 20

# Установить расширения
- Docker

# Защита
sudo apt install fail2ban

# Конфигурация fail2ban
nano /etc/fail2ban/jail.local

# Записать в файл
[sshd]
enabled = true

# Запуск
sudo systemctl start fail2ban
sudo systemctl enable fail2ban

# Проверка
sudo systemctl status fail2ban
sudo fail2ban-client status

# Фаервол 
sudo apt install ufw -y

sudo ufw default deny incoming
sudo ufw default allow outgoing

ufw allow 22
ufw allow 80
ufw allow 443
ufw enable

# Смотреть настройки фаервола
sudo ufw status verbose

# Отключаем вход по ssh по паролю, только по ключам ходить
sudo nano /etc/ssh/sshd_config
должно быть
PasswordAuthentication no

# Автообновление безопасности
apt install unattended-upgrades

# Установка WireGuard
sudo apt install wireguard -y

# Генерация ключей
cd /etc/wireguard
wg genkey | tee privatekey | wg pubkey > publickey

# Конфигурация
nano /etc/wireguard/wg0.conf

# Записать в файл ========================================
[Interface]
PrivateKey = <VPN_ZI_SING_BOX_SERVER_PRIVATE_KEY>
Address = 10.200.0.2/24
ListenPort = 51820
SaveConfig = true

[Peer]
PublicKey = <VPN_ZI_SERVER_PUBLIC_KEY>
AllowedIPs = 10.200.0.1/32
#=========================================================

# Разрешаем порт для WireGuard
ufw allow 51820/udp

# Запуск WireGuard
wg-quick up wg0
systemctl enable wg-quick@wg0

# Перезапуск WireGuard
wg-quick down wg0
wg-quick up wg0

# Проверка WireGuard, когда настроено с двух сторон
wg
# должно быть и обязательно второй блок peer, означающий рукопожатие
#interface: wg0
#  public key: J+52muw0xpGMO+5I+LawDeRnjwuZWcuv0HoT7G5ls3Y=
#  private key: (hidden)
#  listening port: 51820

#peer: AcskgYzdKHmMMzk7pP7isFWPi8BiFaBJCQYZwuc1tXY=
#  endpoint: 85.198.90.14:54537
#  allowed ips: 10.200.0.1/32
#  latest handshake: 4 seconds ago
#  transfer: 180 B received, 92 B sent

# Проверка связи с VPN_ZI_SERVER
ping 10.200.0.1
